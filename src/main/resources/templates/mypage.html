<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link href="/css/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
<div class="max-w-4xl mx-auto py-10 px-6 bg-white shadow rounded">

    <div id="mypage-common" class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-blue-600">ë§ˆì´í˜ì´ì§€</h1>
        <a href="/home" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">í™ˆìœ¼ë¡œ</a>
    </div>

    <p class="text-gray-600 mb-4">ì•ˆë…•í•˜ì„¸ìš”, <span id="nickname"></span>ë‹˜!</p>

    <div class="mb-6">
        <a href="/editmemberinfo" class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded">
            ë‚´ ì •ë³´ ìˆ˜ì •
        </a>
    </div>

    <div id="user-section" class="hidden mt-6">
        <h2 class="text-xl font-semibold mb-2">ğŸ“Œ ë‚´ê°€ ì‘ì„±í•œ ê¸€</h2>
        <ul id="my-posts" class="mb-6 space-y-2"></ul>

        <h2 class="text-xl font-semibold mb-2">â¤ï¸ ì¢‹ì•„ìš” ëˆ„ë¥¸ ê¸€</h2>
        <ul id="my-likes" class="space-y-2"></ul>
    </div>

    <div id="manager-section" class="hidden mt-6">
        <h2 class="text-xl font-semibold mb-2">ğŸš¨ ì‹ ê³  ì ‘ìˆ˜ëœ ê²Œì‹œê¸€</h2>
        <ul id="report-list" class="space-y-2"></ul>

        <h2 class="text-xl font-semibold mt-8 mb-2">â›” ì •ì§€ëœ ì‚¬ìš©ì ëª©ë¡</h2>
        <ul id="suspended-members" class="space-y-2"></ul>
    </div>

    <div id="admin-section" class="hidden mt-6">
        <h2 class="text-xl font-semibold mb-2">ğŸ‘¥ ì „ì²´ íšŒì› ëª©ë¡</h2>
        <ul id="member-list" class="space-y-2"></ul>
    </div>

    <div class="mt-10 text-right">
        <button onclick="withdrawMember()" class="text-sm text-red-500 hover:underline">
            íšŒì›íƒˆí‡´
        </button>
    </div>

</div>

<script>
    function createListItem(html) {
        const li = document.createElement("li");
        li.innerHTML = html;
        li.className = "px-4 py-2 bg-gray-100 rounded shadow-sm";
        return li;
    }

    function loadMyPosts() {
        fetch("/api/members/me/posts")
            .then(res => res.json())
            .then(posts => {
                const list = document.getElementById("my-posts");
                if (!Array.isArray(posts)) return;
                posts.forEach(post => {
                    const html = `ğŸ“„ <a href="/post/${post.postId}" class="text-blue-600 hover:underline">${post.title}</a> (${post.viewCount} ì¡°íšŒ, ${post.likeCount} ì¢‹ì•„ìš”)`;
                    list.appendChild(createListItem(html));
                });
            });
    }

    function loadMyLikes() {
        fetch("/api/members/me/likes")
            .then(res => res.json())
            .then(posts => {
                const list = document.getElementById("my-likes");
                if (!Array.isArray(posts)) return;
                posts.forEach(post => {
                    const html = `ğŸ’– <a href="/post/${post.postId}" class="text-blue-600 hover:underline">${post.title}</a>`;
                    list.appendChild(createListItem(html));
                });
            });
    }

    function loadReports() {
        fetch("/api/manager/post-reports")
            .then(res => res.json())
            .then(reports => {
                const list = document.getElementById("report-list");
                if (!Array.isArray(reports)) return;
                reports.forEach(report => {
                    const html = `ğŸš¨ <a href="/post/${report.postId}" class="text-blue-600 hover:underline font-bold">${report.title}</a><br>
                        ì‹ ê³ ì: ${report.reporterNickname}<br>
                        ì‚¬ìœ : ${report.content}<br>
                        <button onclick="suspendUser(${report.postId}, ${report.reporterId})" class="bg-red-500 text-white px-2 py-1 rounded mr-2">ì •ì§€</button>
                        <button onclick="dismissReport(${report.postId}, ${report.reporterId})" class="bg-gray-400 text-white px-2 py-1 rounded">ê¸°ê°</button>`;
                    list.appendChild(createListItem(html));
                });
            });
    }

    function suspendUser(postId, reporterId) {
        const days = prompt("ì •ì§€ ê¸°ê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1, 3, 7, 30, 9999[ì˜êµ¬ì •ì§€])");
        if (!days) return;
        const reason = prompt("ì •ì§€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        if (!reason) return;

        const until = new Date();
        until.setDate(until.getDate() + parseInt(days));

        fetch("/api/manager/suspend", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                postId, reporterId,
                suspendUntil: until.toISOString().split("T")[0],
                suspendReason: reason
            })
        }).then(() => window.location.reload());
    }

    function dismissReport(postId, reporterId) {
        if (!confirm("ì •ë§ í•´ë‹¹ ì‹ ê³ ë¥¼ ê¸°ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/api/manager/post-reports/${postId}/${reporterId}`, {
            method: "DELETE"
        }).then(() => window.location.reload());
    }

    function loadSuspendedMembers() {
        fetch("/api/manager/suspended-members")
            .then(res => res.json())
            .then(members => {
                const list = document.getElementById("suspended-members");
                if (!Array.isArray(members)) return;
                members.forEach(member => {
                    const html = `ğŸ‘¤ ${member.nickName} / ì•„ì´ë”” : ${member.userId} / ì •ì§€ê¸°í•œ: ${member.suspendUntil || 'ì—†ìŒ'}<br>
                    ì‚¬ìœ : ${member.suspendReason || 'ì—†ìŒ'}<br>
                    <button onclick="unsuspend(${member.userId}, '${member.nickName}')" class="bg-blue-500 text-white px-2 py-1 rounded">ì •ì§€ í•´ì œ</button>`;
                    list.appendChild(createListItem(html));
                });
            });
    }

    function unsuspend(memberId, nickname) {
        if (!confirm(`ì •ë§ ${nickname} ìœ ì €ì˜ ì •ì§€ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        fetch(`/api/manager/unsuspend/${memberId}`, { method: "POST" })
            .then(() => window.location.reload());
    }

    function loadMemberList() {
        fetch("/api/admin/members")
            .then(res => res.json())
            .then(members => {
                const list = document.getElementById("member-list");
                if (!Array.isArray(members)) return;
                members.forEach(member => {
                    const li = document.createElement("li");
                    li.className = "px-4 py-2 bg-gray-100 rounded shadow-sm flex justify-between items-center";

                    const label = document.createElement("span");
                    label.innerText = `ğŸ‘¤ ${member.nickname}`;

                    const select = document.createElement("select");
                    ["NORMAL", "MANAGER", "ADMIN"].forEach(role => {
                        const option = document.createElement("option");
                        option.value = role;
                        option.text = role;
                        if (member.role === role) option.selected = true;
                        select.appendChild(option);
                    });

                    select.className = "ml-4 px-2 py-1 border rounded";
                    select.onchange = () => {
                        fetch(`/api/admin/change-role/${member.id}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ role: select.value })
                        }).then(() => alert("ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."));
                    };

                    li.appendChild(label);
                    li.appendChild(select);
                    list.appendChild(li);
                });
            });
    }

    function withdrawMember() {
        if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("/api/members/me", {
            method: "DELETE"
        })
            .then(res => {
                if (res.ok) {
                    alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.href = "/login";
                } else {
                    alert("íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            })
            .catch(() => alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetch("/api/members/me")
            .then(res => res.json())
            .then(member => {
                document.getElementById("nickname").textContent = member.nickname;

                if (member.role === "NORMAL") {
                    document.getElementById("user-section").classList.remove("hidden");
                    loadMyPosts();
                    loadMyLikes();
                } else {
                    document.getElementById("manager-section").classList.remove("hidden");
                    loadReports();
                    loadSuspendedMembers();

                    if (member.role === "ADMIN") {
                        document.getElementById("admin-section").classList.remove("hidden");
                        loadMemberList();
                    }
                }
            })
            .catch(() => alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."));
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link href="/css/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
<div class="max-w-4xl mx-auto py-10 px-6 bg-white shadow rounded">

    <div id="mypage-common" class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-blue-600">ë§ˆì´í˜ì´ì§€</h1>
        <a href="/home" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">í™ˆìœ¼ë¡œ</a>
    </div>

    <p class="text-gray-600 mb-4">ì•ˆë…•í•˜ì„¸ìš”, <span id="nickname"></span>ë‹˜!</p>

    <div class="mb-6">
        <a href="/editmemberinfo" class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded">
            ë‚´ ì •ë³´ ìˆ˜ì •
        </a>
    </div>

    <div id="user-section" class="hidden mt-6">
        <h2 class="text-xl font-semibold mb-2">ğŸ“Œ ë‚´ê°€ ì‘ì„±í•œ ê¸€</h2>
        <ul id="my-posts" class="mb-6 space-y-2"></ul>

        <h2 class="text-xl font-semibold mb-2">â¤ï¸ ì¢‹ì•„ìš” ëˆ„ë¥¸ ê¸€</h2>
        <ul id="my-likes" class="space-y-2"></ul>
    </div>

    <div id="manager-section" class="hidden mt-6">
        <h2 class="text-xl font-semibold mb-2">ğŸš¨ ì‹ ê³  ì ‘ìˆ˜ëœ ê²Œì‹œê¸€</h2>
        <ul id="report-list" class="space-y-2"></ul>

        <h2 class="text-xl font-semibold mt-8 mb-2">â›” ì •ì§€ëœ ì‚¬ìš©ì ëª©ë¡</h2>
        <ul id="suspended-members" class="space-y-2"></ul>
    </div>

    <div id="admin-section" class="hidden mt-6">
        <h2 class="text-xl font-semibold mb-2">ğŸ‘¥ ì „ì²´ íšŒì› ëª©ë¡</h2>
        <ul id="member-list" class="space-y-2"></ul>
    </div>

    <div class="mt-10 text-right">
        <button onclick="withdrawMember()" class="text-sm text-red-500 hover:underline">
            íšŒì›íƒˆí‡´
        </button>
    </div>

</div>

<script>
    function createListItem(html) {
        const li = document.createElement("li");
        li.innerHTML = html;
        li.className = "px-4 py-2 bg-gray-100 rounded shadow-sm";
        return li;
    }

    async function fetchWithErrorHandling(url, options = {}) {
        const res = await fetch(url, options);
        const contentType = res.headers.get("Content-Type");

        if (!res.ok) {
            if (contentType && contentType.includes("application/json")) {
                const err = await res.json().catch(() => ({ message: "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜" }));
                throw new Error(err.message || "ìš”ì²­ ì‹¤íŒ¨");
            } else {
                throw new Error(await res.text());
            }
        }

        if (res.status === 204) return null; // no content
        if (contentType && contentType.includes("application/json")) {
            return res.json();
        }
        return res.text();
    }

    async function loadMyPosts() {
        try {
            const posts = await fetchWithErrorHandling("/api/members/me/posts");
            const list = document.getElementById("my-posts");
            posts.forEach(post => {
                const html = `ğŸ“„ <a href="/post/${post.postId}" class="text-blue-600 hover:underline">${post.title}</a> (${post.viewCount} ì¡°íšŒ, ${post.likeCount} ì¢‹ì•„ìš”)`;
                list.appendChild(createListItem(html));
            });
        } catch (err) {
            alert(err.message);
        }
    }

    async function loadMyLikes() {
        try {
            const posts = await fetchWithErrorHandling("/api/members/me/likes");
            const list = document.getElementById("my-likes");
            posts.forEach(post => {
                const html = `ğŸ’– <a href="/post/${post.postId}" class="text-blue-600 hover:underline">${post.title}</a>`;
                list.appendChild(createListItem(html));
            });
        } catch (err) {
            alert(err.message);
        }
    }

    async function loadReports() {
        try {
            const reports = await fetchWithErrorHandling("/api/manager/post-reports");
            const list = document.getElementById("report-list");
            reports.forEach(report => {
                const html = `ğŸš¨ <a href="/post/${report.postId}" class="text-blue-600 hover:underline font-bold">${report.title}</a><br>
                        ì‹ ê³ ì: ${report.reporterNickname}<br>
                        ì‚¬ìœ : ${report.content}<br>
                        <button onclick="suspendUser(${report.postId}, ${report.reporterId})" class="bg-red-500 text-white px-2 py-1 rounded mr-2">ì •ì§€</button>
                        <button onclick="dismissReport(${report.postId}, ${report.reporterId})" class="bg-gray-400 text-white px-2 py-1 rounded">ê¸°ê°</button>`;
                list.appendChild(createListItem(html));
            });
        } catch (err) {
            alert(err.message);
        }
    }

    async function suspendUser(postId, reporterId) {
        const days = prompt("ì •ì§€ ê¸°ê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1, 3, 7, 30, 9999[ì˜êµ¬ì •ì§€])");
        if (!days) return;
        const reason = prompt("ì •ì§€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        if (!reason) return;

        const until = new Date();
        until.setDate(until.getDate() + parseInt(days));

        try {
            await fetchWithErrorHandling(`/api/manager/suspend/${reporterId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    suspendUntil: until.toISOString().split("T")[0],
                    suspendReason: reason
                })
            });

            window.location.reload();
        } catch (err) {
            alert(err.message);
        }
    }

    async function dismissReport(postId, reporterId) {
        if (!confirm("ì •ë§ í•´ë‹¹ ì‹ ê³ ë¥¼ ê¸°ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            await fetchWithErrorHandling(`/api/manager/post-reports/${postId}/${reporterId}`, { method: "DELETE" });
            window.location.reload();
        } catch (err) {
            alert(err.message);
        }
    }

    async function loadSuspendedMembers() {
        try {
            const members = await fetchWithErrorHandling("/api/manager/suspended-members");
            const list = document.getElementById("suspended-members");
            members.forEach(member => {
                const html = `ğŸ‘¤ ${member.nickName} / ì•„ì´ë”” : ${member.userId} / ì •ì§€ê¸°í•œ: ${member.suspendUntil || 'ì—†ìŒ'}<br>
                    ì‚¬ìœ : ${member.suspendReason || 'ì—†ìŒ'}<br>
                    <button onclick="unsuspend('${member.memberId}', '${member.nickname}')" class="bg-blue-500 text-white px-2 py-1 rounded">ì •ì§€ í•´ì œ</button>`;
                list.appendChild(createListItem(html));
            });
        } catch (err) {
            alert(err.message);
        }
    }

    async function unsuspend(memberId, nickname) {
        if (!confirm(`ì •ë§ ${nickname} ìœ ì €ì˜ ì •ì§€ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            await fetchWithErrorHandling(`/api/manager/unsuspend/${memberId}`, { method: "POST" });
            window.location.reload();
        } catch (err) {
            alert(err.message);
        }
    }

    async function loadMemberList() {
        try {
            const members = await fetchWithErrorHandling("/api/admin/members");
            const list = document.getElementById("member-list");

            members.forEach(member => {
                const li = document.createElement("li");
                li.className = "px-4 py-2 bg-gray-100 rounded shadow-sm flex justify-between items-center";

                const label = document.createElement("span");
                label.innerText = `ğŸ‘¤ ${member.nickname}`;

                const select = document.createElement("select");
                ["NORMAL", "MANAGER", "ADMIN"].forEach(role => {
                    const option = document.createElement("option");
                    option.value = role;
                    option.text = role;
                    if (member.role === role) option.selected = true;
                    select.appendChild(option);
                });

                select.className = "mr-2 px-2 py-1 border rounded";
                select.onchange = async () => {
                    try {
                        await fetchWithErrorHandling(`/api/admin/change-role/${member.id}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ role: select.value })
                        });
                        alert("ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch (err) {
                        alert(err.message);
                    }
                };

                const withdrawBtn = document.createElement("button");
                withdrawBtn.innerText = "ê°•ì œ íƒˆí‡´";
                withdrawBtn.className = "ml-4 bg-red-500 text-white px-2 py-1 rounded";
                withdrawBtn.onclick = async () => {
                    if (!confirm(`${member.nickname} íšŒì›ì„ ì •ë§ íƒˆí‡´ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?`)) return;

                    try {
                        const res = await fetch(`/api/admin/member/${member.id}`, { method: "DELETE" });

                        if (!res.ok) {
                            const errMsg = await res.text();
                            throw new Error(errMsg);
                        }

                        alert("ê°•ì œ íƒˆí‡´ ì™„ë£Œ");
                        window.location.reload();
                    } catch (err) {
                        alert(err.message);
                    }
                };

                li.appendChild(label);
                li.appendChild(select);
                li.appendChild(withdrawBtn);
                list.appendChild(li);
            });
        } catch (err) {
            alert(err.message);
        }
    }

    async function withdrawMember() {
        if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            await fetchWithErrorHandling("/api/members/me", { method: "DELETE" });
            alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.href = "/login";
        } catch (err) {
            alert(err.message);
        }
    }

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const member = await fetchWithErrorHandling("/api/members/me");
            document.getElementById("nickname").textContent = member.nickname;

            if (member.role === "NORMAL") {
                document.getElementById("user-section").classList.remove("hidden");
                loadMyPosts();
                loadMyLikes();
            } else {
                document.getElementById("manager-section").classList.remove("hidden");
                loadReports();
                loadSuspendedMembers();

                if (member.role === "ADMIN") {
                    document.getElementById("admin-section").classList.remove("hidden");
                    loadMemberList();
                }
            }
        } catch (err) {
            alert(err.message);
        }
    });
</script>
</body>
</html>

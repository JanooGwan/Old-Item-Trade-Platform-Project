<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>홈 - 중고거래 플랫폼</title>
    <link href="/css/tailwind.min.css" rel="stylesheet" />
    <style>
        #image-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        #image-modal img {
            max-height: 80vh;
            max-width: 80vw;
        }
        #image-modal .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 9999px;
            width: 2rem;
            height: 2rem;
            font-weight: bold;
            text-align: center;
            line-height: 2rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<header class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-orange-500">중고마켓</h1>
    <div id="nav-right" class="space-x-4"></div>
</header>

<main class="flex-1 container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">최근 게시글</h2>
        <button id="write-btn" class="px-4 py-2 rounded font-semibold">게시글 쓰기</button>
    </div>
    <div id="post-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</main>

<div id="image-modal" class="hidden fixed inset-0 flex items-center justify-center">
    <div class="close-btn" onclick="closeImageModal()">X</div>
    <img id="modal-img" src="" alt="확대 이미지" class="rounded shadow-lg" />
</div>

<footer class="bg-white shadow-inner p-4 text-center text-sm text-gray-500">
    &copy; 2025 대학교 중고거래마켓. All rights reserved.
</footer>

<script>
    function logout() {
        fetch("/auths/logout", { method: "POST" })
            .then(() => location.href = "/home")
            .catch(err => console.error("로그아웃 실패:", err));
    }

    function openImageModal(url) {
        const modal = document.getElementById("image-modal");
        const img = document.getElementById("modal-img");
        img.src = url;
        modal.classList.remove("hidden");
    }

    function closeImageModal() {
        const modal = document.getElementById("image-modal");
        modal.classList.add("hidden");
    }

    function timeAgo(dateStr) {
        if (!dateStr) return '';
        const now = new Date();
        const date = new Date(dateStr);
        if (isNaN(date)) return '';
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return '방금 전';
        if (diff < 3600) return `${Math.floor(diff / 60)}분 전`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}시간 전`;
        return `${Math.floor(diff / 86400)}일 전`;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("write-btn");

        fetch("/api/posts")
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) return [];
                    throw new Error("게시글 불러오기 실패");
                }
                return response.json();
            })
            .then(data => {
                if (!Array.isArray(data)) return;
                const postList = document.getElementById("post-list");
                if (!postList) return;

                postList.innerHTML = data.map(post => `
                    <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition">
                        <img src="${post.thumbnailImageUrl || '/img/no-image.png'}" class="w-full h-48 object-cover rounded mb-2 cursor-pointer" alt="썸네일 이미지" onclick="openImageModal('${post.thumbnailImageUrl}')"/>
                        <h3 class="text-lg font-bold mb-1">${post.title}</h3>
                        <p class="text-sm text-gray-400">${timeAgo(post.createdDate)}</p>
                        <p class="mt-1 text-sm text-gray-400">조회수 ${post.viewCount} ・ 좋아요 ${post.likeCount}</p>
                        <a href="/post/${post.postId}" class="text-orange-500 hover:underline text-sm">자세히 보기</a>
                    </div>
                `).join("");
            })
            .catch(err => {
                console.error("게시글 불러오기 실패:", err);
            });

        fetch("/api/members/me")
            .then(res => {
                if (!res.ok) throw new Error();
                return res.json();
            })
            .then(data => {
                document.getElementById("nav-right").innerHTML = `
                    <span class="text-sm font-medium text-gray-800">${data.nickname}님, 환영합니다</span>
                    <button onclick="logout()" class="text-sm text-red-500 hover:underline">로그아웃</button>
                `;

                btn.className = "bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded font-semibold";
                btn.disabled = false;
                btn.onclick = () => location.href = "/writepost";
            })
            .catch(() => {
                document.getElementById("nav-right").innerHTML = `
                    <a href="/login" class="text-sm text-gray-700 hover:text-orange-500">로그인</a>
                    <a href="/signup" class="text-sm text-gray-700 hover:text-orange-500">회원가입</a>
                `;

                btn.className = "bg-gray-300 text-gray-500 px-4 py-2 rounded font-semibold opacity-50 cursor-not-allowed";
                btn.disabled = true;
                btn.onclick = () => location.href = "/login";
            });
    });
</script>

</body>
</html>

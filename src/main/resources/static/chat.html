<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>채팅</title>
  <script src="/js/sockjs.min.js"></script>
  <script src="/js/stomp.min.js"></script>
  <link rel="stylesheet" href="/css/chat.css" />
</head>
<body>

<div class="top-bar">
  <div>1:1 채팅</div>
  <div>
    <a href="/mypage/user">마이페이지</a>
    <a href="/home">홈</a>
  </div>
</div>

<div class="chat-container">
  <div class="chat-list">
    <h3>메시지</h3>
    <hr class="chat-divider" />
    <div id="chatroom-list" class="chatroom-list"></div>
  </div>

  <div class="chat-view">
    <div id="message-list" class="message-list"></div>
    <div class="message-input">
      <input type="text" id="message" placeholder="메시지를 입력하세요" />
      <button onclick="sendMessage()">전송</button>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  let currentUserId = null;
  let currentChatRoomId = null;
  let currentSubscription = null;

  window.onload = () => {
    fetch("/api/members/me")
            .then(res => res.json())
            .then(data => {
              currentUserId = data.id;
              localStorage.setItem("memberId", currentUserId);
              connect();
            })
            .catch(() => {
              alert("로그인이 필요합니다.");
              window.location.href = "/login";
            });
  };

  function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
      fetchChatRooms();
      const withNickname = new URLSearchParams(window.location.search).get("with");
      if (withNickname) {
        autoEnterOrCreateRoomByNickname(withNickname);
      }

      document.getElementById("message").addEventListener("keydown", function (e) {
        if (e.key === "Enter") sendMessage();
      });
    });
  }

  function fetchChatRooms() {
    fetch("/api/chatrooms")
            .then(res => res.json())
            .then(data => {
              const list = document.getElementById("chatroom-list");
              list.innerHTML = "";
              data.forEach(room => {
                const div = document.createElement("div");
                div.className = "chatroom-button";
                div.innerText = room.otherUserNickname;
                div.onclick = () => enterChatRoom(room.roomId);
                list.appendChild(div);
              });
            });
  }

  function autoEnterOrCreateRoomByNickname(nickname) {
    fetch("/api/chatrooms/enter-by-nickname", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nickname })
    })
            .then(res => res.json())
            .then(data => {
              if (data.roomId) enterChatRoom(data.roomId);
              else alert("채팅방 정보를 불러올 수 없습니다.");
            })
            .catch(() => alert("채팅방 생성 중 오류가 발생했습니다."));
  }

  function enterChatRoom(roomId) {
    currentChatRoomId = roomId;
    if (currentSubscription) currentSubscription.unsubscribe();
    document.getElementById("message-list").innerHTML = "";

    fetch(`/api/chatrooms/${roomId}/messages`)
            .then(res => res.json())
            .then(messages => {
              messages.forEach(displayMessage);
              markMessagesAsRead(messages); // 읽음 표시 요청
            });

    currentSubscription = stompClient.subscribe("/topic/chatroom." + roomId, function (messageOutput) {
      const msg = JSON.parse(messageOutput.body);
      displayMessage(msg);
    });
  }

  function displayMessage(msg) {
    const list = document.getElementById("message-list");
    const div = document.createElement("div");
    div.classList.add("message");
    div.classList.add(msg.senderId === currentUserId ? "my-message" : "other-message");
    div.innerText = msg.content;

    // 읽음 표시 (내 메시지 중 읽힌 마지막 메시지에만 표시)
    if (msg.senderId === currentUserId && msg.isRead) {
      const read = document.createElement("div");
      read.classList.add("read-label");
      read.innerText = "읽음";
      div.appendChild(read);
    }

    list.appendChild(div);
    list.scrollTop = list.scrollHeight;
  }

  function sendMessage() {
    const content = document.getElementById("message").value.trim();
    if (!currentChatRoomId || !content) return;

    const message = {
      chatRoomId: currentChatRoomId,
      senderId: currentUserId,
      sentAt: Date.now(),
      content
    };

    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
    document.getElementById("message").value = "";
  }

  function markMessagesAsRead(messages) {
    const lastReceived = messages
            .filter(m => m.senderId !== currentUserId && !m.isRead)
            .map(m => m.sentAt)
            .pop();

    if (lastReceived !== undefined) {
      fetch(`/api/chatrooms/${currentChatRoomId}/messages/${lastReceived}/read`, {
        method: "POST"
      });
    }
  }
</script>

</body>
</html>

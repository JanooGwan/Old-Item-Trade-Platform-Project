<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <link href="/css/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen">
<div class="max-w-3xl mx-auto py-10 px-6 bg-white shadow rounded relative">

    <div class="absolute top-4 right-6 flex items-center gap-4">
        <button onclick="location.href='/home'" class="text-sm text-blue-600 hover:underline">ğŸ  í™ˆ</button>
        <div class="flex flex-col items-center">
            <button id="like-btn">
                <span id="heart-icon" class="text-2xl">â™¡</span>
            </button>
            <span id="like-count" class="text-sm text-gray-500">0</span>
        </div>
    </div>

    <h1 id="post-title" class="text-2xl font-bold text-orange-500 mb-2">ì œëª©</h1>
    <p id="post-time" class="text-xs text-gray-400 mb-4">ì‘ì„± ì‹œê°„</p>
    <p id="post-content" class="text-gray-800 mb-4">ë‚´ìš©</p>

    <div id="image-gallery" class="flex gap-2 mb-4"></div>

    <p class="text-sm text-gray-500 mb-1">ì¡°íšŒìˆ˜: <span id="view-count">0</span></p>
    <p class="text-sm text-gray-500 mb-1">êµ¬ë§¤/íŒë§¤: <span id="buy-or-sale"></span></p>
    <p class="text-sm text-gray-500 mb-1">ê±°ë˜ë°©ë²•: <span id="deal-way"></span></p>
    <p class="text-sm text-gray-500">ê°€ê²©: <span id="product-price"></span>ì› | ìˆ˜ëŸ‰: <span id="product-count"></span></p>

    <div id="post-actions" class="mt-6 flex gap-3 hidden">
        <button id="edit-btn" class="bg-blue-500 text-white px-4 py-2 rounded">ìˆ˜ì •</button>
        <button id="delete-btn" class="bg-red-500 text-white px-4 py-2 rounded">ì‚­ì œ</button>
    </div>

    <div class="mt-6 flex gap-3">
        <button id="report-btn" class="bg-red-400 text-white px-4 py-2 rounded">ğŸš¨ ì‹ ê³ í•˜ê¸°</button>
    </div>
</div>

<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
    <div class="relative">
        <img id="modal-image" src="" class="max-w-3xl max-h-[80vh] rounded shadow-lg" />
        <button onclick="closeModal()" class="absolute top-2 right-2 text-white text-xl">âœ•</button>
    </div>
</div>

<!-- ğŸš¨ ì‹ ê³  ëª¨ë‹¬ -->
<div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
    <div class="bg-white p-6 rounded shadow-lg max-w-md w-full relative">
        <h2 class="text-xl font-bold mb-4">ê²Œì‹œê¸€ ì‹ ê³ </h2>
        <textarea id="report-content" rows="4" placeholder="ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full border rounded p-2 mb-4"></textarea>
        <div class="flex justify-end gap-2">
            <button id="cancel-report" class="text-gray-600 px-3 py-1">ì·¨ì†Œ</button>
            <button id="submit-report" class="bg-red-500 text-white px-3 py-1 rounded">ì‹ ê³  ì œì¶œ</button>
        </div>
        <button onclick="closeReportModal()" class="absolute top-2 right-2 text-xl text-gray-600">âœ•</button>
    </div>
</div>

<script>
    const postId = window.location.pathname.split("/").pop();

    function openModal(imageUrl) {
        document.getElementById("modal-image").src = imageUrl;
        document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal() {
        document.getElementById("modal").classList.add("hidden");
    }

    function closeReportModal() {
        document.getElementById("report-modal").classList.add("hidden");
        document.getElementById("report-content").value = "";
    }

    function timeAgo(dateStr) {
        const now = new Date();
        const date = new Date(dateStr);
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return 'ë°©ê¸ˆ ì „';
        if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
        return `${Math.floor(diff / 86400)}ì¼ ì „`;
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetch(`/api/posts/${postId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("post-title").textContent = data.title;
                document.getElementById("post-content").textContent = data.content;
                document.getElementById("view-count").textContent = data.viewCount ?? 0;
                document.getElementById("buy-or-sale").textContent = data.buyOrSale === 'BUY' ? 'êµ¬ë§¤' : 'íŒë§¤';
                document.getElementById("deal-way").textContent = data.dealWay === 'DIRECT' ? 'ì§ê±°ë˜' : 'íƒë°°';
                document.getElementById("product-price").textContent = data.price ?? "-";
                document.getElementById("product-count").textContent = data.count ?? "-";
                document.getElementById("like-count").textContent = data.likeCount ?? 0;
                document.getElementById("post-time").textContent = timeAgo(data.createDate);

                const heartIcon = document.getElementById("heart-icon");
                if (data.liked === true) {
                    heartIcon.textContent = "â¤ï¸";
                }

                const gallery = document.getElementById("image-gallery");
                if (Array.isArray(data.images)) {
                    data.images.forEach(url => {
                        const wrapper = document.createElement("div");
                        wrapper.className = "relative w-24 h-24";

                        const img = document.createElement("img");
                        img.src = url;
                        img.alt = "post image";
                        img.className = "w-full h-full object-cover rounded border";

                        const zoomBtn = document.createElement("button");
                        zoomBtn.innerText = "ğŸ”";
                        zoomBtn.className = "absolute bottom-1 right-1 text-sm bg-white rounded px-1 shadow";
                        zoomBtn.onclick = () => openModal(url);

                        wrapper.appendChild(img);
                        wrapper.appendChild(zoomBtn);
                        gallery.appendChild(wrapper);
                    });
                }

                if (data.author === true) {
                    document.getElementById("post-actions").classList.remove("hidden");

                    document.getElementById("delete-btn").addEventListener("click", () => {
                        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            fetch(`/api/posts/${postId}`, { method: "DELETE" })
                                .then(res => {
                                    if (!res.ok) throw new Error();
                                    alert("ì‚­ì œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                                    location.href = "/home";
                                })
                                .catch(() => alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
                        }
                    });

                    document.getElementById("edit-btn").addEventListener("click", () => {
                        location.href = `/editpost/${postId}`;
                    });
                }

                const likeBtn = document.getElementById("like-btn");
                const likeCountSpan = document.getElementById("like-count");

                likeBtn.addEventListener("click", () => {
                    fetch(`/likes/${postId}`, { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            heartIcon.textContent = data.liked ? "â¤ï¸" : "â™¡";
                            likeCountSpan.textContent = data.likeCount;
                        })
                        .catch(() => alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨"));
                });
            })
            .catch(() => {
                alert("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });

        // ğŸš¨ ì‹ ê³ í•˜ê¸° ê´€ë ¨ ì²˜ë¦¬
        const reportBtn = document.getElementById("report-btn");
        const reportModal = document.getElementById("report-modal");
        const reportContent = document.getElementById("report-content");
        const cancelReport = document.getElementById("cancel-report");
        const submitReport = document.getElementById("submit-report");

        reportBtn.addEventListener("click", () => {
            reportModal.classList.remove("hidden");
        });

        cancelReport.addEventListener("click", () => {
            closeReportModal();
        });

        submitReport.addEventListener("click", () => {
            const content = reportContent.value.trim();
            if (!content) {
                alert("ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            fetch("/api/post-reports", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ postId, content })
            })
                .then(res => {
                    if (!res.ok) throw new Error("ì‹ ê³  ì‹¤íŒ¨");
                    return res.json();
                })
                .then(data => {
                    alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeReportModal();
                })
                .catch(err => {
                    alert(err.message || "ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        });
    });
</script>
</body>
</html>
